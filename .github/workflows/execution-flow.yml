name: Autimated Testing
on: 
  push:
    branches:
      - main
  pull_request:
    types: 
      - closed
    branches:
      - main
  workflow_dispatch:
env:
  DEPLOYMENT_MESSAGE: Deployment has been successful!
jobs:
  test:
    continue-on-error: true
    strategy:
      matrix:
        node-version: [20,21,22]
    runs-on: ubuntu-latest
    steps: 
      - name: Get code
        uses: actions/checkout@v4
      - name: Install NodeJs
        uses: actions/setup-node@v3
        with:
          node-version: ${{matrix.node-version}}
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: deps-node-modules-${{ hashFiles('**/package-lock.json') }}
      - name: Install new dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Test code 
        run: npm run test
      - name: Check coverage
        run: npm run coverage
      - name: Upload coverage artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{matrix.node-version}}-html
          path: coverage/**
      - name: Show coverage percentage
        if: success()
        run: |
            LCOV_FILE="coverage/lcov.info"
            if [ ! -f "$LCOV_FILE" ]; then
              echo "lcov.info not found at $LCOV_FILE"
              exit 1
            fi

            # Sum LF (lines found) and LH (lines hit) across all records, then print percentage with 2 decimals
            COVERAGE=$(awk -F: '/^LF:/ {lf+=$2} /^LH:/ {lh+=$2} END{if (lf>0) printf("%.2f", (lh/lf)*100); else print "0.00"}' "$LCOV_FILE")

            echo "Coverage Percentage: ${COVERAGE}%"


      - name: Build code
        run: npm run build
      - name: Notify Teams on Success
        if: success()
        
        run: |
            curl -X POST \
              -H 'Content-Type: application/json' \
              -d '{
                "type": "message",
                "attachments": [
                  {
                    "contentType": "application/vnd.microsoft.card.adaptive",
                    "contentUrl": null,
                    "content": {
                      "type": "AdaptiveCard",
                      "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                      "version": "1.4",
                      "body": [
                        {
                          "type": "TextBlock",
                          "size": "Large",
                          "weight": "Bolder",
                          "text": "âœ… Build successful"
                        },
                        {
                          "type": "TextBlock",
                          "wrap": true,
                          "spacing": "Small",
                          "text": "Node.js version: ${{ matrix.node-version }}"
                        },
                        {
                          "type": "FactSet",
                          "facts": [
                            { "title": "Repository", "value": "${{ github.repository }}" },
                            { "title": "Branch",     "value": "${{ github.ref_name }}" },
                            { "title": "Commit",     "value": "${{ github.sha }}" }
                          ]
                        }
                      ],
                      "actions": [
                        {
                          "type": "Action.OpenUrl",
                          "title": "View Workflow Run",
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  }
                ]
              }' \
              "${{ secrets.TEAMS_WEBHOOK_URL }}"


      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: project-build-${{matrix.node-version}}
          path: dist/**
      - name: Custom Action
        id: hello
        uses: actions/hello-world-javascript-action@v1
        with:
          who-to-greet: 'Martin Redondo'
      - name: Show output
        run: echo "The action greeted at ${{steps.hello.outputs.time}}"
      - name: Deploy project
        run: echo "${{env.DEPLOYMENT_MESSAGE}}"


# https://default76a2ae5a9f004f6b95ed5d33d77c4d.61.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/f4d115430c6946629f6fde49a3209838/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=L-SdkoJzfJ3p73g3p4y0iiIz4w68WgU82c17r8jCB3M